#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
LINK_CONFIG="link.conf.yaml"
PACAUR_CONFIG="pacaur.conf.yaml"
BREW_CONFIG="brew.conf.yaml"
SHELL_CONFIG="shell.conf.yaml"

DOTBOT_DIR="dotbot"
SHELLSETUP_DIR="dotfiles-example"
DOTBOT_BREW_DIR="dotbot-brew"
DOTBOT_PACAUR_DIR="dotbot-pacaur"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

OS=$(uname -s)

cd "${BASEDIR}"
git submodule update --init --recursive "${DOTBOT_DIR}"
git submodule update --init --recursive "${SHELLSETUP_DIR}"
git submodule update --init --recursive "${DOTBOT_PACAUR_DIR}"

{
echo "# install.conf.yaml generated by install script"
echo ""
cat "${BASEDIR}/${LINK_CONFIG}"
cat "${BASEDIR}/${SHELL_CONFIG}"

} >> "$CONFIG"

if [[ "$OS" == "Darwin" ]]; then
  # macOS
  cat "${BASEDIR}/${BREW_CONFIG}" >> "$CONFIG"
  PLUGIN_DIR="${BASEDIR}/${DOTBOT_BREW_DIR}"
elif [[ "$OS" == "Linux" ]]; then
  # Assuming Arch Linux
  cat "${BASEDIR}/${PACAUR_CONFIG}" >> "$CONFIG"
  PLUGIN_DIR="${BASEDIR}/${DOTBOT_PACAUR_DIR}"
else
  # Windows, FreeBSD, Solaris, etc...
  >&2 echo "$OS is not supported for installation."
  exit 1
fi


"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" \
  --plugin-dir "$PLUGIN_DIR" "${@}"
