#!/usr/bin/env bash

set -e

CONFIG="install.conf.yaml"
LINK_CONFIG="link.conf.yaml"
YAOURT_CONFIG="packages.conf.yaml"
BREW_CONFIG="brew.conf.yaml"
SHELL_CONFIG="shell.conf.yaml"

DOTBOT_DIR="dotbot"
SHELLSETUP_DIR="dotfiles-example"
DOTBOT_BREW_DIR="dotbot-brew"
DOTBOT_YAOURT_DIR="dotbot-yaourt"
SCRIPTS_DIR="scripts"

DOTBOT_BIN="bin/dotbot"
BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

OS=$(uname -s)

cd "${BASEDIR}"
git submodule update --init --recursive "${DOTBOT_DIR}"
git submodule update --init --recursive "${SHELLSETUP_DIR}"
git submodule update --init --recursive "${DOTBOT_YAOURT_DIR}"

echo "# install.conf.yaml generated by install script" > "$CONFIG"
echo "" >> "$CONFIG"

cat "${BASEDIR}/${LINK_CONFIG}" >> "$CONFIG"
cat "${BASEDIR}/${SHELL_CONFIG}" >> "$CONFIG"

if [[ "$OS" == "Darwin" ]]; then
  # macOS
  cat "${BASEDIR}/${BREW_CONFIG}" >> "$CONFIG"
  PLUGIN_DIR="${BASEDIR}/${DOTBOT_BREW_DIR}"
elif [[ "$OS" == "Linux" ]]; then
  # Assuming Arch Linux
  cat "${BASEDIR}/${YAOURT_CONFIG}" >> "$CONFIG"
  PLUGIN_DIR="${BASEDIR}/${DOTBOT_YAOURT_DIR}"
else
  # Windows, FreeBSD, Solaris, etc...
  >&2 echo "$OS is not supported for installation."
  exit 1
fi


"${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" -d "${BASEDIR}" -c "${CONFIG}" \
  --plugin-dir "$PLUGIN_DIR" "${@}"
